<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hefi istriku ❤️ - نسخة محسّنة</title>
  <style>
    :root {
      --heart-color: #ff4081;
      --star-color: #ffeb3b;
      --bg-gradient-start: #ffdee9;
      --bg-gradient-end: #b5fffc;
      --cell-bg: rgba(255, 255, 255, 0.95);
      --cell-hover: rgba(255, 224, 240, 0.98);
      --shadow-color: rgba(0, 0, 0, 0.1);
      --winning-cell-glow: 0 0 15px 5px;
      --grid-size: 15;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
      text-align: center;
      margin: 0;
      padding: 10px;
      min-height: 100vh;
      perspective: 1000px;
      overflow-x: hidden;
      transition: background 1s ease;
    }
    
    .login, .game {
      display: none;
      margin: 15px auto;
      max-width: 650px;
      animation: fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1);
      transform-style: preserve-3d;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px) rotateX(10deg); }
      to { opacity: 1; transform: translateY(0) rotateX(0); }
    }
    
    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      background: rgba(255, 255, 255, 0.85);
      border-radius: 16px;
      padding: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .scores-container {
      display: flex;
      gap: 20px;
      font-size: 18px;
      font-weight: 600;
    }
    
    .player-score {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px 15px;
      border-radius: 12px;
      min-width: 100px;
      transition: all 0.3s ease;
    }
    
    .player-score.player1 {
      background: rgba(255, 64, 129, 0.15);
      border: 2px solid var(--player1-color);
    }
    
    .player-score.player2 {
      background: rgba(255, 235, 59, 0.15);
      border: 2px solid var(--player2-color);
    }
    
    .player-name {
      font-size: 16px;
      margin-bottom: 5px;
      font-weight: 600;
    }
    
    .score-value {
      font-size: 24px;
      font-weight: 700;
    }
    
    .grid-container {
      margin: 15px auto;
      width: 100%;
      max-width: 600px;
      perspective: 1000px;
      overflow: auto;
      padding: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      border-radius: 16px;
      background: rgba(255,255,255,0.25);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    .grid {
      display: grid;
      grid-template-columns: repeat(var(--grid-size), 1fr);
      gap: 3px;
      transform-style: preserve-3d;
      margin: 0 auto;
      width: fit-content;
    }
    
    .cell {
      position: relative;
      background: var(--cell-bg);
      border: none;
      font-size: 16px;
      width: 30px;
      height: 30px;
      line-height: 30px;
      cursor: pointer;
      border-radius: 6px;
      box-shadow: 0 3px 6px var(--shadow-color),
                  0 0 0 1px rgba(255,255,255,0.95) inset,
                  2px 2px 4px rgba(0,0,0,0.08);
      transform-style: preserve-3d;
      transition: all 0.25s cubic-bezier(0.25, 0.8, 0.25, 1);
      transform: translateZ(0);
      overflow: hidden;
    }
    
    .cell::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, 
                rgba(255,255,255,0.4) 0%, 
                rgba(255,255,255,0.15) 50%,
                rgba(0,0,0,0.02) 100%);
      border-radius: 6px;
      z-index: -1;
    }
    
    .cell::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at center, 
                rgba(255,255,255,0.9) 0%, 
                rgba(255,255,255,0) 70%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .cell:hover {
      transform: translateZ(8px) scale(1.12);
      box-shadow: 0 6px 12px var(--shadow-color),
                  0 0 0 1px rgba(255,255,255,0.98) inset,
                  3px 3px 6px rgba(0,0,0,0.12);
      z-index: 2;
    }
    
    .cell:hover::after {
      opacity: 0.7;
    }
    
    .cell.X {
      color: var(--heart-color);
      text-shadow: 0 0 10px rgba(255, 64, 129, 0.7);
      animation: heartBeat 0.6s ease;
    }
    
    .cell.O {
      color: var(--star-color);
      text-shadow: 0 0 10px rgba(255, 235, 59, 0.7);
      animation: starPulse 0.6s ease;
    }
    
    @keyframes heartBeat {
      0% { transform: scale(1); }
      25% { transform: scale(1.2); }
      50% { transform: scale(0.9); }
      75% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    @keyframes starPulse {
      0% { transform: rotate(0deg) scale(1); }
      25% { transform: rotate(10deg) scale(1.2); }
      50% { transform: rotate(-10deg) scale(0.9); }
      75% { transform: rotate(5deg) scale(1.1); }
      100% { transform: rotate(0deg) scale(1); }
    }
    
    .cell.winning-cell {
      animation: winningGlow 1.2s infinite alternate;
      z-index: 10;
    }
    
    .cell.winning-cell.X {
      box-shadow: var(--winning-cell-glow) rgba(255, 64, 129, 0.7);
    }
    
    .cell.winning-cell.O {
      box-shadow: var(--winning-cell-glow) rgba(255, 235, 59, 0.7);
    }
    
    @keyframes winningGlow {
      0% { 
        transform: translateZ(5px) scale(1);
        box-shadow: 0 0 12px 4px;
      }
      100% { 
        transform: translateZ(15px) scale(1.1);
        box-shadow: 0 0 20px 8px;
      }
    }
    
    #winner {
      font-size: 22px;
      margin: 15px;
      font-weight: bold;
      color: #4a148c;
      animation: pulse 1.2s infinite alternate;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: relative;
      z-index: 5;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1.05); }
    }
    
    input, button {
      padding: 12px 18px;
      margin: 12px;
      font-size: 16px;
      border-radius: 10px;
      border: none;
      box-shadow: 0 4px 8px var(--shadow-color);
      width: 80%;
      max-width: 300px;
      transition: all 0.3s ease;
    }
    
    input:focus {
      outline: none;
      box-shadow: 0 0 0 3px var(--heart-color), 
                  0 4px 10px var(--shadow-color);
      transform: translateY(-2px);
    }
    
    button {
      background: linear-gradient(45deg, var(--heart-color), #e91e63);
      color: white;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      position: relative;
      overflow: hidden;
      font-weight: 600;
    }
    
    button::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(
        to bottom right,
        rgba(255,255,255,0.4) 0%,
        rgba(255,255,255,0) 60%
      );
      transform: rotate(30deg);
      transition: all 0.5s ease;
    }
    
    button:hover {
      transform: translateY(-4px) scale(1.03);
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }
    
    button:active {
      transform: translateY(1px);
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }
    
    button:hover::before {
      left: 100%;
    }
    
    #turnInfo {
      font-size: 17px;
      margin: 15px;
      padding: 10px 20px;
      border-radius: 25px;
      background: rgba(255,255,255,0.85);
      display: inline-block;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      font-weight: 600;
    }
    
    #turnInfo::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent 0%,
        rgba(255,255,255,0.6) 50%,
        transparent 100%
      );
      animation: shine 2s infinite;
    }
    
    @keyframes shine {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    /* Floating particles */
    .particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
    }
    
    .particle {
      position: absolute;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0) 70%);
      animation: float linear infinite;
    }
    
    @keyframes float {
      to {
        transform: translateY(-100vh) rotate(360deg);
      }
    }
    
    /* Chat styles with enhanced effects */
    #chatToggleBtn {
      position: fixed;
      bottom: 25px;
      right: 25px;
      width: 65px;
      height: 65px;
      background: linear-gradient(135deg, #ff4081, #e91e63);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2),
                  inset 0 -5px 10px rgba(0,0,0,0.1),
                  inset 0 5px 10px rgba(255,255,255,0.3);
      border: none;
      font-size: 26px;
      transform-style: preserve-3d;
      transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      z-index: 100;
      display: none;
    }
    
    #chatToggleBtn::before {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: radial-gradient(circle at center, 
                rgba(255,255,255,0.5) 0%, 
                rgba(255,255,255,0) 70%);
      animation: pulseRing 2s infinite;
    }
    
    @keyframes pulseRing {
      0% { transform: scale(0.9); opacity: 0.8; }
      100% { transform: scale(1.6); opacity: 0; }
    }
    
    #chatToggleBtn:hover {
      transform: translateZ(12px) scale(1.1);
      box-shadow: 0 15px 30px rgba(0,0,0,0.25),
                  inset 0 -5px 10px rgba(0,0,0,0.1),
                  inset 0 5px 10px rgba(255,255,255,0.3);
    }
    
    .chat-container {
      position: fixed;
      bottom: 100px;
      right: 25px;
      width: 320px;
      background: rgba(255, 255, 255, 0.98);
      border-radius: 18px;
      box-shadow: 0 12px 35px rgba(0,0,0,0.2);
      z-index: 99;
      display: none;
      transform: translateZ(0);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,0.4);
      overflow: hidden;
      transform-origin: bottom right;
      animation: chatScale 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    @keyframes chatScale {
      from { transform: scale(0.85); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    
    .chat-header {
      background: linear-gradient(45deg, #ff4081, #e91e63);
      color: white;
      padding: 14px;
      border-radius: 18px 18px 0 0;
      font-weight: bold;
      font-size: 17px;
      text-shadow: 0 1px 3px rgba(0,0,0,0.2);
      letter-spacing: 0.5px;
    }
    
    .chat-messages {
      height: 220px;
      overflow-y: auto;
      padding: 14px;
      font-size: 15px;
      scroll-behavior: smooth;
    }
    
    /* Custom scrollbar */
    .chat-messages::-webkit-scrollbar {
      width: 7px;
    }
    
    .chat-messages::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.05);
      border-radius: 4px;
    }
    
    .chat-messages::-webkit-scrollbar-thumb {
      background: rgba(255,64,129,0.6);
      border-radius: 4px;
    }
    
    .message {
      margin-bottom: 12px;
      padding: 10px 14px;
      border-radius: 14px;
      background: rgba(255, 224, 240, 0.7);
      word-break: break-word;
      transform-origin: bottom;
      animation: messageAppear 0.3s ease;
      transition: all 0.3s ease;
      line-height: 1.4;
    }
    
    @keyframes messageAppear {
      from { transform: scale(0.92); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    
    .message:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .message.sent {
      background: linear-gradient(135deg, rgba(255, 64, 129, 0.2), rgba(255, 64, 129, 0.3));
      text-align: right;
      margin-left: 40px;
      border-bottom-right-radius: 5px;
    }
    
    .message.received {
      background: linear-gradient(135deg, rgba(255, 235, 59, 0.2), rgba(255, 235, 59, 0.3));
      text-align: left;
      margin-right: 40px;
      border-bottom-left-radius: 5px;
    }
    
    .message-sender {
      font-weight: bold;
      font-size: 13px;
      color: #880e4f;
      margin-bottom: 5px;
    }
    
    .chat-input {
      display: flex;
      padding: 12px;
      background: rgba(255,255,255,0.98);
      border-radius: 0 0 18px 18px;
      border-top: 1px solid rgba(0,0,0,0.08);
    }
    
    .chat-input input {
      flex: 1;
      padding: 10px 14px;
      margin: 0;
      font-size: 15px;
      border-radius: 20px;
      border: 1px solid rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    
    .chat-input input:focus {
      border-color: var(--heart-color);
      box-shadow: 0 0 0 3px rgba(255,64,129,0.25);
    }
    
    .chat-input button {
      padding: 10px 18px;
      margin-left: 10px;
      border-radius: 20px;
      font-size: 15px;
      width: auto;
      min-width: 70px;
    }
    
    /* Confetti effect */
    .confetti-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
      display: none;
    }
    
    .confetti {
      position: absolute;
      width: 12px;
      height: 12px;
      background-color: #f00;
      opacity: 0;
      animation: confetti-fall 3s ease-in-out forwards;
    }
    
    @keyframes confetti-fall {
      0% {
        transform: translateY(-100px) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }
    
    /* Background animation */
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    /* Notification badge */
    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ff4081;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      animation: pulse 1.5s infinite;
    }
    
    /* إشعارات رسائل محسّنة */
    .message-notification {
      position: fixed;
      bottom: 100px;
      right: 25px;
      width: 350px;
      background: linear-gradient(135deg, #ffffff, #f9f9f9);
      border-radius: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.05);
      z-index: 101;
      display: none;
      transform: translateX(120%);
      animation: slideIn 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards;
      overflow: hidden;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      border: 1px solid rgba(255,255,255,0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    @keyframes slideIn {
      0% { transform: translateX(120%); }
      100% { transform: translateX(0); }
    }
    
    @keyframes fadeOut {
      0% { opacity: 1; transform: translateX(0); }
      100% { opacity: 0; transform: translateX(20px); }
    }
    
    .message-notification-content {
      padding: 20px;
      position: relative;
    }
    
    .message-notification-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }
    
    .message-notification-icon {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #ff4081, #e91e63);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      color: white;
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(255,64,129,0.3);
    }
    
    .message-notification-title {
      font-weight: bold;
      font-size: 18px;
      color: #333;
    }
    
    .message-notification-subtitle {
      font-size: 14px;
      color: #777;
      margin-top: 4px;
    }
    
    .message-notification-body {
      font-size: 16px;
      color: #444;
      line-height: 1.5;
      margin-bottom: 15px;
      padding: 12px 15px;
      background: rgba(255, 224, 240, 0.3);
      border-radius: 12px;
      border-left: 3px solid #ff4081;
    }
    
    .message-notification-sender {
      font-weight: bold;
      color: #ff4081;
      display: inline-block;
      margin-right: 5px;
    }
    
    .notification-scores {
      display: flex;
      justify-content: space-between;
      background: rgba(255,255,255,0.7);
      border-radius: 12px;
      padding: 12px 15px;
      margin-top: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.05);
    }
    
    .player-score-notification {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
    }
    
    .player-score-notification.player1 {
      border-right: 1px solid rgba(0,0,0,0.1);
    }
    
    .player-name-notification {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 5px;
      color: #555;
    }
    
    .player-score-value {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(135deg, #ff4081, #e91e63);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .player-score-notification.player2 .player-score-value {
      background: linear-gradient(135deg, #ffeb3b, #ffc107);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .message-notification-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid rgba(0,0,0,0.08);
      font-size: 12px;
      color: #888;
    }
    
    .close-notification {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #aaa;
      transition: color 0.3s, transform 0.3s;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .close-notification:hover {
      color: #ff4081;
      background: rgba(255,64,129,0.1);
      transform: rotate(90deg);
    }
    
    .notification-timestamp {
      font-size: 13px;
      color: #888;
    }
    
    /* تأثيرات إضافية */
    .message-notification:before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #ff4081, #ffeb3b);
      animation: progressBar 5s linear forwards;
    }
    
    @keyframes progressBar {
      0% { width: 100%; }
      100% { width: 0%; }
    }
    
    /* تأثيرات الاهتزاز */
    @keyframes vibrate {
      0% { transform: translateX(0); }
      25% { transform: translateX(-3px); }
      50% { transform: translateX(3px); }
      75% { transform: translateX(-3px); }
      100% { transform: translateX(0); }
    }
    
    .vibrate {
      animation: vibrate 0.4s ease;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .grid-container {
        max-width: 95%;
        padding: 10px;
      }
      
      .cell {
        width: 32px;
        height: 32px;
        line-height: 32px;
        font-size: 24px;
      }
      
      .chat-container {
        width: 90%;
        right: 5%;
      }
      
      #chatToggleBtn {
        width: 55px;
        height: 55px;
        font-size: 22px;
        bottom: 20px;
        right: 20px;
      }
      
      .header-container {
        flex-direction: column;
        gap: 15px;
      }
      
      .scores-container {
        width: 100%;
        justify-content: space-around;
      }
      
      .message-notification {
        width: 90%;
        right: 5%;
        max-width: 300px;
      }
    }
  </style>
</head>
<body>
  <div class="login" id="login">
    <h2 style="animation: bounce 2s infinite;">Hefi istriku ❤️</h2>
    <input type="text" id="nameInput" placeholder="Nama">
    <input type="text" id="roomInput" placeholder="Kode Ruangan">
    <button onclick="joinGame()">Mulai</button>
  </div>
  
  <div class="game" id="game">
    <div class="header-container">
      <h2 id="roomTitle"></h2>
      <div class="scores-container">
        <div class="player-score player1" id="player1Score">
          <div class="player-name" id="player1Name">Player 1</div>
          <div class="score-value">0</div>
        </div>
        <div class="player-score player2" id="player2Score">
          <div class="player-name" id="player2Name">Player 2</div>
          <div class="score-value">0</div>
        </div>
      </div>
    </div>
    
    <div id="turnInfo"></div>
    <div class="grid-container">
      <div class="grid" id="grid"></div>
    </div>
    <div id="winner"></div>
    <button id="restartButton" onclick="restartGame()">Main Lagi</button>
  </div>

  <div class="particles" id="particles"></div>
  <div class="confetti-container" id="confettiContainer"></div>
  
  <button id="chatToggleBtn">💬<span class="notification-badge" id="notificationBadge" style="display: none">0</span></button>
  <div class="chat-container" id="chatContainer">
    <div class="chat-header">Chat dengan Lawan</div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input type="text" id="chatInput" placeholder="Ketik pesan...">
      <button id="sendMessageBtn">Kirim</button>
    </div>
  </div>
  
  <!-- إشعار الرسالة المحسّن -->
  <div class="message-notification" id="messageNotification">
    <div class="message-notification-content">
      <button class="close-notification" onclick="closeNotification()">✕</button>
      <div class="message-notification-header">
        <div class="message-notification-icon">💬</div>
        <div>
          <div class="message-notification-title">Pesan baru</div>
          <div class="message-notification-subtitle">Dari pemain di dalam ruangan</div>
        </div>
      </div>
      <div class="message-notification-body">
        <span class="message-notification-sender" id="notificationSender"></span>
        <span id="notificationMessage"></span>
      </div>
      
      <div class="notification-scores">
        <div class="player-score-notification player1">
          <div class="player-name-notification" id="notificationPlayer1">Player 1</div>
          <div class="player-score-value" id="notificationScore1">0</div>
        </div>
        <div class="player-score-notification player2">
          <div class="player-name-notification" id="notificationPlayer2">Player 2</div>
          <div class="player-score-value" id="notificationScore2">0</div>
        </div>
      </div>
      
      <div class="message-notification-footer">
        <div class="notification-timestamp" id="notificationTime"></div>
        <div>Hefi Game</div>
      </div>
    </div>
  </div>

  <audio id="clickSound" src="https://assets.mixkit.co/sfx/preview/mixkit-positive-interface-beep-221.mp3"></audio>
  <audio id="messageSound" src="https://assets.mixkit.co/sfx/preview/mixkit-happy-bells-notification-937.mp3"></audio>
  <audio id="winSound" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3"></audio>
  <audio id="backgroundMusic" loop src="https://assets.mixkit.co/music/preview/mixkit-happy-times-158.mp3"></audio>

  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script>
    // Firebase configuration (replace with your own)
    const firebaseConfig = {
      apiKey: "AIzaSyDMkW_cZQUP9Fb-XXXXXXXXXXXXXX",
      authDomain: "hefi-love-game.firebaseapp.com",
      projectId: "hefi-love-game",
      storageBucket: "hefi-love-game.appspot.com",
      messagingSenderId: "347257937190",
      appId: "1:347257937190:web:xxxxxxxxxxxxxxxx",
      databaseURL: "https://hefi-love-game-default-rtdb.firebaseio.com"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const loginDiv = document.getElementById("login");
    const gameDiv = document.getElementById("game");
    const grid = document.getElementById("grid");
    const winnerDiv = document.getElementById("winner");
    const roomTitle = document.getElementById("roomTitle");
    const turnInfo = document.getElementById("turnInfo");
    const restartButton = document.getElementById("restartButton");
    const chatToggleBtn = document.getElementById("chatToggleBtn");
    const chatContainer = document.getElementById("chatContainer");
    const chatMessages = document.getElementById("chatMessages");
    const chatInput = document.getElementById("chatInput");
    const sendMessageBtn = document.getElementById("sendMessageBtn");
    const particlesContainer = document.getElementById("particles");
    const confettiContainer = document.getElementById("confettiContainer");
    const backgroundMusic = document.getElementById("backgroundMusic");
    const player1Score = document.getElementById("player1Score");
    const player2Score = document.getElementById("player2Score");
    const player1Name = document.getElementById("player1Name");
    const player2Name = document.getElementById("player2Name");
    const notificationBadge = document.getElementById("notificationBadge");
    const messageNotification = document.getElementById("messageNotification");
    const notificationSender = document.getElementById("notificationSender");
    const notificationMessage = document.getElementById("notificationMessage");
    const notificationScore1 = document.getElementById("notificationScore1");
    const notificationScore2 = document.getElementById("notificationScore2");
    const notificationPlayer1 = document.getElementById("notificationPlayer1");
    const notificationPlayer2 = document.getElementById("notificationPlayer2");
    const notificationTime = document.getElementById("notificationTime");

    let playerName = "", playerSymbol = "", roomCode = "", isMyTurn = false, roomRef = null;
    let musicPlaying = false;
    let unreadMessages = 0;
    let currentRoomState = null;
    const GRID_SIZE = 15;
    const WINNING_LENGTH = 6;

    loginDiv.style.display = "block";
    createParticles(30);

    function createParticles(count) {
      for (let i = 0; i < count; i++) {
        const particle = document.createElement("div");
        particle.classList.add("particle");
        
        const size = Math.random() * 6 + 3;
        const posX = Math.random() * 100;
        const duration = Math.random() * 20 + 10;
        const delay = Math.random() * 10;
        const opacity = Math.random() * 0.7 + 0.3;
        
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        particle.style.left = `${posX}%`;
        particle.style.animationDuration = `${duration}s`;
        particle.style.animationDelay = `${delay}s`;
        particle.style.opacity = opacity;
        
        particlesContainer.appendChild(particle);
      }
    }

    function createConfetti() {
      confettiContainer.innerHTML = '';
      confettiContainer.style.display = 'block';
      
      const colors = ['#ff4081', '#ffeb3b', '#4caf50', '#2196f3', '#9c27b0'];
      const confettiCount = 120;
      
      for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement("div");
        confetti.classList.add("confetti");
        
        const size = Math.random() * 12 + 6;
        const posX = Math.random() * 100;
        const duration = Math.random() * 3 + 2;
        const delay = Math.random() * 2;
        const color = colors[Math.floor(Math.random() * colors.length)];
        const shape = Math.random() > 0.5 ? '50%' : '0';
        
        confetti.style.width = `${size}px`;
        confetti.style.height = `${size}px`;
        confetti.style.left = `${posX}%`;
        confetti.style.animationDuration = `${duration}s`;
        confetti.style.animationDelay = `${delay}s`;
        confetti.style.backgroundColor = color;
        confetti.style.borderRadius = shape;
        
        confettiContainer.appendChild(confetti);
      }
      
      setTimeout(() => {
        confettiContainer.style.display = 'none';
      }, 3000);
    }

    function toggleMusic() {
      if (musicPlaying) {
        backgroundMusic.pause();
      } else {
        backgroundMusic.play().catch(e => console.log("Autoplay prevented:", e));
      }
      musicPlaying = !musicPlaying;
    }

    function joinGame() {
      playerName = document.getElementById("nameInput").value.trim();
      roomCode = document.getElementById("roomInput").value.trim();
      if (!playerName || !roomCode) {
        shakeInputs();
        return;
      }

      document.body.style.animation = "gradientShift 15s ease infinite";
      document.body.style.backgroundSize = "200% 200%";
      
      roomRef = db.ref("rooms/" + roomCode);
      roomRef.once("value", snap => {
        const data = snap.val();
        if (!data) {
          roomRef.set({
            players: { player1: playerName },
            board: Array(GRID_SIZE * GRID_SIZE).fill(""),
            turn: "X",
            status: "waiting",
            messages: {},
            scores: { player1: 0, player2: 0 }
          });
          playerSymbol = "X";
          isMyTurn = true;
        } else {
          const players = data.players || {};
          if (players.player2) {
            showError("Ruangan sudah penuh!");
            return;
          }
          roomRef.child("players/player2").set(playerName);
          roomRef.child("status").set("playing");
          playerSymbol = "O";
          isMyTurn = false;
        }
        loginDiv.style.display = "none";
        gameDiv.style.display = "block";
        chatToggleBtn.style.display = "flex";
        roomTitle.textContent = "Ruangan: " + roomCode;
        listenToRoom(roomRef);
        
        toggleMusic();
      });
    }

    function showError(message) {
      const errorDiv = document.createElement("div");
      errorDiv.textContent = message;
      errorDiv.style.position = "fixed";
      errorDiv.style.top = "20px";
      errorDiv.style.left = "50%";
      errorDiv.style.transform = "translateX(-50%)";
      errorDiv.style.backgroundColor = "#ff4081";
      errorDiv.style.color = "white";
      errorDiv.style.padding = "12px 24px";
      errorDiv.style.borderRadius = "8px";
      errorDiv.style.boxShadow = "0 4px 12px rgba(0,0,0,0.2)";
      errorDiv.style.zIndex = "1000";
      errorDiv.style.animation = "fadeIn 0.3s, fadeOut 0.3s 2.7s";
      document.body.appendChild(errorDiv);
      
      setTimeout(() => {
        errorDiv.remove();
      }, 3000);
    }

    function shakeInputs() {
      const inputs = document.querySelectorAll("input");
      inputs.forEach(input => {
        input.style.animation = "shake 0.5s";
        setTimeout(() => {
          input.style.animation = "";
        }, 500);
      });
    }

    function listenToRoom(ref) {
      ref.on("value", snap => {
        const data = snap.val();
        if (!data || !data.board) return;
        
        currentRoomState = data;
        
        grid.innerHTML = "";
        data.board.forEach((cell, i) => {
          const div = document.createElement("div");
          div.className = `cell ${cell}`;
          div.innerHTML = cell === "X" ? "❤️" : cell === "O" ? "💛" : "";
          div.onclick = () => makeMove(i, ref, data);
          grid.appendChild(div);
        });

        if (data.status === "playing") {
          turnInfo.textContent = data.turn === playerSymbol ? "Giliran Kamu!" : "Menunggu lawan...";
          isMyTurn = data.turn === playerSymbol;
          
          if (isMyTurn) {
            turnInfo.style.animation = "pulseTurn 1.5s infinite";
          } else {
            turnInfo.style.animation = "";
          }
        }

        if (data.winner) {
          const winnerName = data.winner.symbol === "X" ? data.players.player1 : data.players.player2;
          winnerDiv.innerHTML = `🎉 ${winnerName} menang!`;
          document.getElementById("winSound").play();
          restartButton.style.display = "inline-block";
          
          createConfetti();
          
          if (data.winner.winningCells) {
            data.winner.winningCells.forEach(index => {
              const cell = document.querySelectorAll('.cell')[index];
              if (cell) cell.classList.add('winning-cell');
            });
          }
        } else {
          restartButton.style.display = "none";
        }
        
        // Update player names and scores
        if (data.players) {
          player1Name.textContent = data.players.player1 || "Player 1";
          player2Name.textContent = data.players.player2 || "Player 2";
          player1Score.querySelector('.score-value').textContent = data.scores?.player1 || 0;
          player2Score.querySelector('.score-value').textContent = data.scores?.player2 || 0;
        }
      });

      ref.child("messages").on("child_added", snap => {
        const message = snap.val();
        if (message) {
          const isCurrentPlayer = message.sender === playerName;
          const messageDiv = document.createElement("div");
          messageDiv.className = `message ${isCurrentPlayer ? 'sent' : 'received'}`;
          messageDiv.innerHTML = `<div class="message-sender">${message.sender}</div><div>${message.text}</div>`;
          chatMessages.appendChild(messageDiv);
          chatMessages.scrollTop = chatMessages.scrollHeight;
          
          if (!isCurrentPlayer) {
            document.getElementById("messageSound").play();
            
            // Show message notification
            showMessageNotification(message.sender, message.text);
            
            // Show notification badge if chat is closed
            if (chatContainer.style.display !== "block") {
              unreadMessages++;
              notificationBadge.textContent = unreadMessages;
              notificationBadge.style.display = "flex";
            }
          }
        }
      });
    }
    
    function showMessageNotification(sender, message) {
      // Update notification content
      notificationSender.textContent = sender;
      notificationMessage.textContent = message;
      
      // Update scores
      notificationScore1.textContent = currentRoomState?.scores?.player1 || 0;
      notificationScore2.textContent = currentRoomState?.scores?.player2 || 0;
      
      // Update player names
      notificationPlayer1.textContent = currentRoomState?.players?.player1 || "Player 1";
      notificationPlayer2.textContent = currentRoomState?.players?.player2 || "Player 2";
      
      // Update timestamp
      const now = new Date();
      const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      notificationTime.textContent = `Sent at ${timeString}`;
      
      // Show notification
      messageNotification.style.display = "block";
      messageNotification.classList.remove('vibrate');
      
      // Reset animation
      messageNotification.style.animation = 'none';
      setTimeout(() => {
        messageNotification.style.animation = 'slideIn 0.6s forwards';
        messageNotification.classList.add('vibrate');
      }, 10);
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        closeNotification();
      }, 5000);
    }
    
    function closeNotification() {
      messageNotification.style.animation = 'fadeOut 0.5s forwards';
      
      setTimeout(() => {
        messageNotification.style.display = "none";
      }, 500);
    }

    function makeMove(index, ref, data) {
      if (!isMyTurn || data.board[index] !== "" || data.winner) return;
      
      document.getElementById("clickSound").play();
      
      const cell = document.querySelectorAll('.cell')[index];
      const ripple = document.createElement("span");
      ripple.style.position = "absolute";
      ripple.style.borderRadius = "50%";
      ripple.style.transform = "scale(0)";
      ripple.style.animation = "ripple 0.6s linear";
      ripple.style.backgroundColor = playerSymbol === "X" ? "rgba(255, 64, 129, 0.4)" : "rgba(255, 235, 59, 0.4)";
      cell.appendChild(ripple);
      
      const rect = cell.getBoundingClientRect();
      const size = Math.max(rect.width, rect.height) * 1.5;
      ripple.style.width = `${size}px`;
      ripple.style.height = `${size}px`;
      ripple.style.left = `${0 - (size - rect.width) / 2}px`;
      ripple.style.top = `${0 - (size - rect.height) / 2}px`;
      
      setTimeout(() => {
        ripple.remove();
      }, 600);
      
      data.board[index] = playerSymbol;
      const nextTurn = playerSymbol === "X" ? "O" : "X";
      const winner = checkWin(data.board);
      
      let updates = {
        board: data.board,
        turn: nextTurn
      };
      
      if (winner) {
        // Update scores
        const winnerKey = winner.symbol === 'X' ? 'player1' : 'player2';
        const newScores = {...data.scores || {player1: 0, player2: 0}};
        newScores[winnerKey] = (newScores[winnerKey] || 0) + 1;
        
        updates = {
          ...updates,
          winner: winner,
          scores: newScores
        };
      }
      
      ref.update(updates);
    }

    function checkWin(board) {
      const lines = [];
      // Check for 6 consecutive symbols in all directions
      for (let r = 0; r < GRID_SIZE; r++) {
        for (let c = 0; c < GRID_SIZE; c++) {
          const i = r * GRID_SIZE + c;
          // Horizontal
          if (c <= GRID_SIZE - WINNING_LENGTH) {
            lines.push(Array.from({length: WINNING_LENGTH}, (_, idx) => i + idx));
          }
          // Vertical
          if (r <= GRID_SIZE - WINNING_LENGTH) {
            lines.push(Array.from({length: WINNING_LENGTH}, (_, idx) => i + idx * GRID_SIZE));
          }
          // Diagonal ↘
          if (r <= GRID_SIZE - WINNING_LENGTH && c <= GRID_SIZE - WINNING_LENGTH) {
            lines.push(Array.from({length: WINNING_LENGTH}, (_, idx) => i + idx * (GRID_SIZE + 1)));
          }
          // Diagonal ↙
          if (r <= GRID_SIZE - WINNING_LENGTH && c >= WINNING_LENGTH - 1) {
            lines.push(Array.from({length: WINNING_LENGTH}, (_, idx) => i + idx * (GRID_SIZE - 1)));
          }
        }
      }
      
      for (const line of lines) {
        const firstSymbol = board[line[0]];
        if (firstSymbol && line.every(index => board[index] === firstSymbol)) {
          return { symbol: firstSymbol, winningCells: line };
        }
      }
      return null;
    }

    function restartGame() {
      if (!roomRef) return;
      
      document.querySelectorAll('.winning-cell').forEach(cell => {
        cell.classList.remove('winning-cell');
      });
      
      roomRef.update({
        board: Array(GRID_SIZE * GRID_SIZE).fill(""),
        turn: "X",
        winner: null,
        status: "playing"
      });
    }

    function sendMessage() {
      const message = chatInput.value.trim();
      if (message && roomRef) {
        document.getElementById("messageSound").play();
        roomRef.child("messages").push().set({
          sender: playerName,
          text: message,
          timestamp: Date.now()
        });
        chatInput.value = "";
      }
    }

    chatToggleBtn.addEventListener("click", () => {
      const isVisible = chatContainer.style.display === "block";
      chatContainer.style.display = isVisible ? "none" : "block";
      chatToggleBtn.innerHTML = isVisible ? "💬" : "✕";
      chatToggleBtn.style.transform = isVisible ? "translateZ(0)" : "translateZ(12px) rotate(15deg)";
      
      // Reset notification badge when opening chat
      if (!isVisible) {
        unreadMessages = 0;
        notificationBadge.style.display = "none";
      }
    });

    sendMessageBtn.addEventListener("click", sendMessage);
    chatInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    // Add CSS for new animations
    const style = document.createElement("style");
    style.textContent = `
      @keyframes ripple {
        to {
          transform: scale(2.5);
          opacity: 0;
        }
      }
      
      @keyframes pulseTurn {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,64,129,0.5); }
        70% { transform: scale(1.08); box-shadow: 0 0 0 12px rgba(255,64,129,0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,64,129,0); }
      }
      
      @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-12px); }
      }
      
      @keyframes fadeOut {
        to { opacity: 0; transform: translateX(-50%) translateY(-25px); }
      }
      
      @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-6px); }
        20%, 40%, 60%, 80% { transform: translateX(6px); }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>